@using System.Linq
@using System.Collections.Generic
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Agendar Cita";
    var fecha = ViewBag.Fecha as DateOnly? ?? DateOnly.FromDateTime(DateTime.Today);
    var horarios = ViewBag.Horarios as IEnumerable<EnfHorario> ?? Enumerable.Empty<EnfHorario>();
    var tipoUsuario = ViewBag.TipoUsuario as string ?? "";
    var fechaSoloHoy = (ViewBag.FechaSoloHoy as bool?) ?? false;
    var actionName = ViewContext.ActionDescriptor.RouteValues["action"];
    var prev = fecha.AddDays(-1);
    var next = fecha.AddDays(1);
    string fmt(DateOnly d) => d.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd");
}

<div class="container py-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h2 class="mb-2 mb-md-0">@ViewData["Title"]</h2>
        <div><strong>Fecha:</strong> @fecha.ToDateTime(TimeOnly.MinValue).ToString("dd/MM/yyyy")</div>
    </div>

    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-success">@TempData["Mensaje"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (!fechaSoloHoy)
    {
        <div class="d-flex justify-content-between mb-3">
            <a class="btn btn-outline-secondary" asp-action="@actionName" asp-route-fecha="@fmt(prev)">← Día anterior</a>
            <a class="btn btn-outline-secondary" asp-action="@actionName" asp-route-fecha="@fmt(next)">Día siguiente →</a>
        </div>
    }

    @if (tipoUsuario == "Profesor")
    {
        <button class="btn btn-danger mb-3 w-100 w-md-auto"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#emergModal">
            Agendar Emergencia
        </button>
    }

    @if (!horarios.Any())
    {
        <div class="alert alert-info text-center">No hay horarios disponibles para la fecha seleccionada.</div>
    }
    else
    {
        <!-- ✅ Versión responsiva -->
        <div class="table-responsive d-none d-md-block">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th class="text-end">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in horarios)
                    {
                        <tr>
                            <td>@h.Hora</td>
                            <td>@h.Estado</td>
                            <td class="text-end">
                                <form asp-action="@actionName" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="horarioId" value="@h.Id" />
                                    <button type="submit" class="btn btn-success btn-sm">Reservar</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- ✅ Vista tipo “tarjeta” para móviles -->
        <div class="d-md-none">
            <div class="row g-2">
                @foreach (var h in horarios)
                {
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">@h.Hora</div>
                                    <div class="small text-muted">@h.Estado</div>
                                </div>
                                <form asp-action="@actionName" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="horarioId" value="@h.Id" />
                                    <button type="submit" class="btn btn-success btn-sm">Reservar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<form id="antiForgeryForm">@Html.AntiForgeryToken()</form>

<!-- Modal de emergencia -->
<div class="modal fade" id="emergModal" tabindex="-1" aria-hidden="true" aria-labelledby="emergModalLabel">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emergModalLabel">Buscar estudiante para emergencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <input id="buscador" class="form-control mb-2" placeholder="Escribe nombre o cédula..." autocomplete="off" />
                <ul id="resultados" class="list-group"></ul>
                <div id="msg" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const buscador = document.getElementById('buscador');
            const lista = document.getElementById('resultados');
            const msg = document.getElementById('msg');
            const endpointSearch = '@Url.Action("BuscarEstudiantes", "Citas")';
            const endpointCreate = '@Url.Action("Emergencia", "Citas")';
            let t = null;

            const getToken = () => document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value ?? '';

            const renderList = (items) => {
                lista.innerHTML = '';
                msg.innerHTML = '';
                if (!items || items.length === 0) return;
                for (const it of items) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action';
                    li.textContent = `${it.nombre} — ${it.cedula}`;
                    li.onclick = async () => {
                        msg.innerHTML = 'Agendando...';
                        const body = new URLSearchParams({ cedula: it.cedula, __RequestVerificationToken: getToken() });
                        const resp = await fetch(endpointCreate, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body });
                        const data = await resp.json().catch(() => ({}));
                        msg.innerHTML = data.ok
                            ? `<div class="text-success">✔ ${data.msg}</div>`
                            : `<div class="text-danger">✘ ${data.msg ?? 'Error al agendar.'}</div>`;
                    };
                    lista.appendChild(li);
                }
            };

            const buscar = async (q) => {
                if (!q.trim()) { lista.innerHTML = ''; msg.innerHTML = ''; return; }
                const r = await fetch(`${endpointSearch}?q=${encodeURIComponent(q)}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const data = await r.json().catch(() => []);
                renderList(data);
            };

            buscador?.addEventListener('input', () => { clearTimeout(t); t = setTimeout(() => buscar(buscador.value), 300); });
            document.getElementById('emergModal')?.addEventListener('shown.bs.modal', () => { buscador.value = ''; lista.innerHTML = ''; msg.innerHTML = ''; buscador.focus(); });
        })();
    </script>
}
