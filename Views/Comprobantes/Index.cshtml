@model IEnumerable<Enfermeria_app.Models.EnfCita>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Comprobantes de Citas";
    var desde = ViewBag.Desde as string ?? DateTime.Today.ToString("yyyy-MM-dd");
    var hasta = ViewBag.Hasta as string ?? DateTime.Today.ToString("yyyy-MM-dd");
    var nombre = ViewBag.Nombre as string ?? "";
}

<div class="container-fluid px-3">
    <h2 class="mb-4">@ViewData["Title"]</h2>

    <form id="formFiltros" class="row g-2 align-items-end mb-3">
        <div class="col-6 col-md-3">
            <label for="desde" class="form-label">Desde:</label>
            <input type="date" class="form-control" id="desde" name="desde" value="@desde" />
        </div>
        <div class="col-6 col-md-3">
            <label for="hasta" class="form-label">Hasta:</label>
            <input type="date" class="form-control" id="hasta" name="hasta" value="@hasta" />
        </div>
        <div class="col-12 col-md-4">
            <label for="nombre" class="form-label">Buscar por nombre o cédula:</label>
            <input type="text" class="form-control" id="nombre" name="nombre" value="@nombre" placeholder="Buscar por nombre o cédula..." />
        </div>
        <div class="col-12 col-md-2 text-md-end">
            <button type="submit" class="btn btn-primary w-100 mt-2">Filtrar</button>
        </div>
    </form>

    <div id="tablaContainer">
        @await Html.PartialAsync("_TablaComprobantes", Model)
    </div>
</div>

@section Scripts {
    <script>
        const form = document.getElementById('formFiltros');
        const tablaContainer = document.getElementById('tablaContainer');
        const nombreInput = document.getElementById('nombre');

        // Filtrar manualmente
        form.addEventListener('submit', async e => {
            e.preventDefault();
            await cargarTabla();
        });

        // Filtro en tiempo real (al escribir)
        let timer;
        nombreInput.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(cargarTabla, 400);
        });

        async function cargarTabla() {
            const desde = document.getElementById('desde').value;
            const hasta = document.getElementById('hasta').value;
            const nombre = document.getElementById('nombre').value;

            const params = new URLSearchParams();
            if (desde) params.append('desde', desde);
            if (hasta) params.append('hasta', hasta);
            if (nombre) params.append('nombre', nombre);

            const url = '@Url.Action("Index", "Comprobantes")' + '?' + params.toString();

            try {
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const html = await response.text();
                tablaContainer.innerHTML = html;
            } catch (err) {
                console.error(err);
                tablaContainer.innerHTML = '<div class="alert alert-danger">Error al cargar los datos.</div>';
            }
        }
    </script>
}
